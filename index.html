<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Minute Workout</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      REMOVED Tone.js script. 
      We will use the native Web Audio API instead.
    --><style>
        /* Use the Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style for the SVG progress circle transition */
        #progressCircle {
            transition: stroke-dashoffset 1s linear;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen">

    <!-- Main Workout Container --><main class="w-full max-w-md p-6 sm:p-10 bg-gray-800 rounded-2xl shadow-xl text-center">
        


        <!-- Timer Circle (NOT Clickable for Pause Anymore) --><div id="timerEl" class="relative w-56 h-56 sm:w-64 sm:h-64 mx-auto my-6 rounded-full shadow-inner flex items-center justify-center bg-gray-700 cursor-default"> <!-- Changed cursor-pointer to cursor-default --><!-- SVG for progress circle --><svg class="w-full h-full" viewBox="0 0 120 120">
                <!-- Background circle --><circle class="text-gray-600" cx="60" cy="60" r="54" fill="none" stroke="currentColor" stroke-width="12" />
                <!-- Progress circle (animated) --><circle id="progressCircle" class="text-blue-400" cx="60" cy="60" r="54" fill="none"
                    stroke="currentColor" stroke-width="12"
                    transform="rotate(-90 60 60)"
                    stroke-dasharray="339.29" 
                    stroke-dashoffset="0" />
            </svg>
            
            <!-- Timer Text --><div id="timerDisplay" class="absolute text-7xl sm:text-8xl font-black text-blue-400">10</div>
            
            <!-- Pause / Play Overlay --><div id="pausePlayOverlay" class="absolute inset-0 w-full h-full rounded-full bg-gray-800/90 flex items-center justify-center hidden transition-opacity duration-300">
                <!-- NEW Pause Icon --><svg id="pauseIcon" class="w-20 h-20 text-blue-400 hidden" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h2c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm8 0h-2c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h2c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path>
                </svg>
                <!-- NEW Play Icon --><svg id="playIcon" class="w-20 h-20 text-blue-400 hidden" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 5v14l11-7L8 5z"></path>
                </svg>
            </div>
        </div>

        <!-- Next Exercise --><div class="h-14">
            <div class="text-base font-semibold text-gray-400 uppercase tracking-wide">NEXT UP:</div> <!-- Changed text-sm to text-base -->
            <div id="nextExerciseEl" class="text-2xl font-bold uppercase">Jumping Jacks</div> <!-- Changed text-xl to text-2xl and added uppercase -->
        </div>

        <!-- Start/Reset Button --><button id="startButton" class="w-full p-4 mt-6 bg-blue-500 text-white rounded-lg text-xl font-bold uppercase hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-800 transition-all duration-300 transform active:scale-95">
            Start Workout
        </button>

    </main>

    <!-- Generic Message Box (for errors, etc.) --><div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 id="messageTitle" class="text-lg font-bold mb-4">Message</h3>
            <p id="messageText" class="text-gray-300 mb-6">This is a message.</p>
            <button id="messageCloseButton" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-800">
                OK
            </button>
        </div>
    </div>


    <script>
        window.addEventListener('load', () => {
            
            // --- DOM Elements ---
            const statusEl = document.getElementById('statusEl');
            const exerciseEl = document.getElementById('exerciseEl');
            const timerDisplay = document.getElementById('timerDisplay');
            const timerEl = document.getElementById('timerEl');
            const nextExerciseEl = document.getElementById('nextExerciseEl');
            const startButton = document.getElementById('startButton');
            const pausePlayOverlay = document.getElementById('pausePlayOverlay'); // Renamed from pauseOverlay
            const pauseIcon = document.getElementById('pauseIcon');
            const playIcon = document.getElementById('playIcon');
            const progressCircle = document.getElementById('progressCircle');

            // --- Message Box Elements ---
            const messageBox = document.getElementById('messageBox');
            const messageTitle = document.getElementById('messageTitle');
            const messageText = document.getElementById('messageText');
            const messageCloseButton = document.getElementById('messageCloseButton');

            /**
             * Shows the generic message box (defined early)
             * @param {string} title - The title of the message.
             * @param {string} text - The body text of the message.
             */
            function showMessage(title, text) {
                messageTitle.textContent = title;
                messageText.textContent = text;
                messageBox.classList.remove('hidden');
            }
            
            messageCloseButton.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // --- Native Web Audio API Setup ---
            let audioContext;
            let isAudioReady = false; // Flag to track if audio is unlocked

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    isAudioReady = false;
                } else if (audioContext.state === 'running') {
                    isAudioReady = true;
                }
            } catch (e) {
                console.error("Web Audio API is not supported in this browser.", e);
                showMessage("Audio Error", "Your browser does not support the Web Audio API needed for sounds.");
                startButton.disabled = true; // Disable if audio is impossible
                startButton.textContent = "Audio Not Supported";
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
                return; // Stop all further execution
            }

            // --- Try to unlock audio on *any* user click (e.g., in a restrictive iframe) ---
            async function unlockAudio() {
                if (isAudioReady || !audioContext || audioContext.state === 'running') {
                    isAudioReady = true;
                    return;
                }
                
                try {
                    await audioContext.resume();
                    isAudioReady = true;
                    console.log("Audio Context Unlocked by user gesture.");
                    document.body.removeEventListener('click', unlockAudio);
                } catch (e) {
                    console.warn("Could not unlock audio on click:", e);
                    // The main startWorkout function will handle the error visibly if it's still not running
                }
            }
            // Add this listener to the whole body, to catch the *first* user interaction
            document.body.addEventListener('click', unlockAudio, { once: true });
            
            // REMOVED setupAudio() function, as it's no longer needed

            // --- Workout Definition ---
            const EXERCISES = [
                "Jumping Jacks",
                "Wall Sit",
                "Push-ups",
                "Abdominal Crunch",
                "Step-up onto Chair",
                "Squat",
                "Triceps Dip on Chair",
                "Plank",
                "High Knees",
                "Lunge",
                "Push-up & Rotation",
                "Side Plank" // User can switch halfway
            ];
            
            const READY_TIME = 10;
            const WORK_TIME = 30;
            const REST_TIME = 10;
            const CIRCLE_CIRCUMFERENCE = 339.29; // 2 * pi * 54

            let workoutSequence = [];
            let currentExerciseIndex = 0;
            let timer = null;
            let timeLeft = 0;
            let isPaused = false;
            let isStarted = false;

            // --- Core Functions ---

            /**
             * Handles clicks on the main button
             * Starts, pauses, or resumes the workout
             */
            async function handleStartPauseClick() {
                if (!isStarted) {
                    // This is the first "Start Workout" click or a "Start Over" click
                    await startWorkout();
                } else {
                    // Workout is in progress, so toggle pause
                    togglePause();
                }
            }

            /**
             * Generates the full workout sequence array
             */
            function createWorkoutSequence() {
                workoutSequence = []; // Reset sequence
                workoutSequence.push({ type: 'ready', name: 'Get Ready', duration: READY_TIME });

                EXERCISES.forEach((exercise, index) => {
                    workoutSequence.push({ type: 'work', name: exercise, duration: WORK_TIME });
                    if (index < EXERCISES.length - 1) {
                        workoutSequence.push({ type: 'rest', name: 'Rest', duration: REST_TIME });
                    }
                });

                workoutSequence.push({ type: 'complete', name: 'Workout Complete!', duration: 0 });
            }

            /**
             * Main function to start or reset the workout
             */
            async function startWorkout() {
                // Check if audio is ready, if not, try to resume it
                if (!isAudioReady && audioContext.state !== 'running') {
                    try {
                        await audioContext.resume();
                        isAudioReady = true;
                        console.log("Audio Context Resumed on workout start.");
                    } catch (e) {
                        console.error("AudioContext.resume() failed:", e);
                        showMessage("Audio Error", "Could not start audio. Please ensure your browser allows audio playback and try again.");
                        return; // Stop if we can't get audio
                    }
                }

                // REMOVED setupAudio() block

                // Reset all state variables
                isStarted = true;
                isPaused = false;
                currentExerciseIndex = 0;
                clearInterval(timer);
                
                createWorkoutSequence();
                loadExercise(currentExerciseIndex);
                startTimer();

                startButton.textContent = "Pause"; // Changed from "Restart Workout"
                pausePlayOverlay.classList.add('hidden'); // Hide overlay
                pauseIcon.classList.add('hidden'); // Ensure pause icon is hidden
                playIcon.classList.remove('hidden'); // Show play icon during active workout
            }

            /**
             * Loads the exercise at the given index into the UI
             */
            function loadExercise(index) {
                const current = workoutSequence[index];
                const next = workoutSequence[index + 1] || { name: "All Done!" };

                timeLeft = current.duration;
                updateTimerDisplay();

                statusEl.textContent = current.type === 'work' ? 'Workout' : current.type;
                exerciseEl.textContent = current.name;
                nextExerciseEl.textContent = next.name;

                // Update colors based on state
                updateColors(current.type);

                if (current.type === 'complete') {
                    startButton.textContent = "Start Over?";
                    playCompleteChime();
                    isStarted = false; // This will make the button restart the workout
                    clearInterval(timer);
                    pausePlayOverlay.classList.remove('hidden'); // Show overlay
                    pauseIcon.classList.remove('hidden'); // Show pause icon
                    playIcon.classList.add('hidden'); // Hide play icon
                }
            }
            
            /**
             * Starts the 1-second interval timer
             */
            function startTimer() {
                clearInterval(timer); // Clear any existing timer
                timer = setInterval(tick, 1000);
            }

            /**
             * The main timer "tick" function, called every second
             */
            function tick() {
                if (isPaused) {
                    return; // Do nothing if paused
                }

                if (timeLeft <= 0) {
                    handleTimerEnd();
                    return;
                }
                
                timeLeft--;
                updateTimerDisplay();

                // Play audio cues
                if (timeLeft === 3 || timeLeft === 2 || timeLeft === 1) {
                    playCountdownBeep();
                }
            }
            
            /**
             * Called when a timer reaches 0. Loads next exercise or ends.
             */
            function handleTimerEnd() {
                clearInterval(timer);
                currentExerciseIndex++;
                
                if (currentExerciseIndex < workoutSequence.length) {
                    const currentType = workoutSequence[currentExerciseIndex].type;
                    if (currentType === 'work' || currentType === 'rest') {
                        playStartBeep(); // "Go" sound for next phase
                    }
                    loadExercise(currentExerciseIndex);
                    
                    // Only restart timer if not complete
                    if (currentType !== 'complete') {
                        startTimer();
                    }
                }
            }

            /**
             * Toggles the pause state of the workout
             */
            function togglePause() {
                if (!isStarted || workoutSequence[currentExerciseIndex].type === 'complete') {
                    return; // Can't pause if not started or if complete
                }
                isPaused = !isPaused;
                pausePlayOverlay.classList.toggle('hidden', !isPaused); // Toggle overlay visibility
                pauseIcon.classList.toggle('hidden', !isPaused); // Show pause icon when paused
                playIcon.classList.toggle('hidden', isPaused); // Show play icon when not paused

                // Update button text based on new state
                if (isPaused) {
                    startButton.textContent = "Resume";
                } else {
                    startButton.textContent = "Pause";
                }
            }

            // --- UI & Audio Helper Functions ---

            /**
             * Updates the timer display and progress circle
             */
            function updateTimerDisplay() {
                timerDisplay.textContent = timeLeft;
                const totalDuration = workoutSequence[currentExerciseIndex].duration;
                
                // Calculate progress (0 to 1)
                const progress = totalDuration > 0 ? (totalDuration - timeLeft) / totalDuration : 0;
                
                // Calculate SVG dash offset
                const offset = CIRCLE_CIRCUMFERENCE * (1 - progress);
                progressCircle.style.strokeDashoffset = offset;
            }

            /**
             * Updates element colors based on the current state
             * @param {string} type - 'ready', 'work', 'rest', or 'complete'
             */
            function updateColors(type) {
                let colorClass = 'blue';
                let suffix = '400'; // Dark theme
                if (type === 'rest') colorClass = 'green';
                if (type === 'ready') colorClass = 'indigo';
                if (type === 'complete') {
                    colorClass = 'gray';
                    suffix = '500'; // Gray 400 is a bit light
                }

                // Remove old colors (both light and dark theme potentials)
                ['blue', 'green', 'indigo', 'gray'].forEach(c => {
                    statusEl.classList.remove(`text-${c}-600`);
                    timerDisplay.classList.remove(`text-${c}-600`);
                    progressCircle.classList.remove(`text-${c}-600`);
                    statusEl.classList.remove(`text-${c}-400`);
                    timerDisplay.classList.remove(`text-${c}-400`);
                    progressCircle.classList.remove(`text-${c}-400`);
                    statusEl.classList.remove(`text-${c}-500`);
                    timerDisplay.classList.remove(`text-${c}-500`);
                    progressCircle.classList.remove(`text-${c}-500`);
                });

                // Add new colors
                statusEl.classList.add(`text-${colorClass}-${suffix}`);
                timerDisplay.classList.add(`text-${colorClass}-${suffix}`);
                progressCircle.classList.add(`text-${colorClass}-${suffix}`);
            }

            /**
             * Plays a note using the Web Audio API
             * @param {number} frequency - The frequency of the note (in Hz)
             * @param {number} duration - The duration of the note (in seconds)
             * @param {string} type - The oscillator type ('sine', 'square', 'sawtooth', 'triangle')
             */
            function playNote(frequency, duration, type = 'sine') {
                if (!isAudioReady || !audioContext) return;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                // Simple attack/decay envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01); // Quick attack
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }


            function playCountdownBeep() {
                playNote(880, 0.1, 'sine'); // High C
            }

            function playStartBeep() {
                playNote(440, 0.2, 'triangle'); // A4
            }

            function playCompleteChime() {
                if (!isAudioReady || !audioContext) return;
                const now = audioContext.currentTime;
                // Play a simple C-E-G-C arpeggio
                playNote(523.25, 0.3, 'sine'); // C5
                playNote(659.25, 0.3, 'sine'); // E5
                playNote(783.99, 0.3, 'sine'); // G5
                playNote(1046.50, 0.4, 'sine'); // C6
            }
            
            // --- Event Listeners ---
            startButton.addEventListener('click', handleStartPauseClick); 
            
            // --- Initial Setup ---
            createWorkoutSequence();
            loadExercise(0); // Load the "Get Ready" state initially

        });
    </script>
</body>
</html>



